# MAGMA_extension
MAGMA celltyping analysis based on disease state of subjects

## Introduction

This R package can be used to generate cell type data files based on patient_id of single cell RNA sequencing data and to run MAGMA celltyping on each individual, allowing a comparison of cell type association results between disease and control subjects.

The package is an extension of the R packages "EWCE" (https://github.com/NathanSkene/EWCE) and MAGMA_Celltyping (https://github.com/NathanSkene/MAGMA_Celltyping)

For the installation and further details, please check these packages.


## Installation

Before installing this package it is neccesary to install the magma software package. Please download it from https://ctg.cncr.nl/software/magma. Please do note, the magma software which forms the backend of this package was developed by Christian de Leeuw from Daniella Posthuma's lab. If you use this package to generate publishable results then you must cite their publication (listed below).

The executable should be copied to /usr/local/bin so that R can find it. Then install this package as follows:

For the installation and further details, please check the above mentioned packages.

```
install.packages("devtools")
library(devtools)
install_github("nathanskene/ewce")
install_github("ChristophH/sctransform")
install_github("nathanskene/MAGMA_Celltyping")
install_github("KristinaSalontaji/MAGMA_extension")
```

## Using the package (basic usage)

### Set parameters to be used for the analysis

```{r, eval=FALSE}
# Set path the 1000 genomes reference data.
genome_ref_dir = "~/Downloads/g1000_eur"
if(!file.exists(sprintf("%s/g1000_eur.bed",genome_ref_dir))){
    download.file("https://ctg.cncr.nl/software/MAGMA/ref_data/g1000_eur.zip",destfile=sprintf("%s.zip",genome_ref_dir))
    unzip(sprintf("%s.zip",genome_ref_dir),exdir=genome_ref_dir)
}
genome_ref_path = sprintf("%s/g1000_eur",genome_ref_dir)
```

### Install and load all the required R packages and data

The MAGMA_extension package comes with a single cell RNA-seq dataset with cell IDs as columns and genes as rows 
The package also comes with annotation data which contains "cell_id", "level1class", "level2_class", "patient_id" and "pathology" columns. 
For the tutorial, we first need to load these datasets. 

```{r, eval=FALSE }
library(EWCE)
library(MAGMA.Celltyping)
library(MAGMA_extension)

# Load the raw data
data(TM2_rawcounts)

# Load the annotation data
data(TM2_annot)
```

### Generate the cell type data files based on individual subjects

After loading the raw data and the annotation data with the previously mentioned column specifications, we can run the generate.individual.ctds function.
This step makes use of the sctransform (https://github.com/ChristophH/sctransform) by default. While it is recommended to use sctransform, it is possible to skip this step by setting the "sc_transform" argument to save time.

```{r, eval=FALSE }
ctd_loc = generate.individual.ctds(exp,annot, numCores = 4)
```
The function returns a list containing the names of each celltype data file and will be used in the next analyses steps.


### Download summary statistics file & check it is properly formatted

Before running the magma.run.individual.analysis function, we need to have a summary statistics file to analyse as input. As an example download summary statistics for Fluid Intelligence, based on the UK Biobank, generated by Ben Neale's group.

The function `format_sumstats_for_magma` does some basic processing to get it into the right format. Please note, this function is NOT guarenteed to work. It will work on some sumstats but until the community gets it's act together and standardises how we share these, it is not possible to write a generic function for this. If it doesn't work then what you will need to roll your sleeves up and just reformat the file yourself such that the following criteria are met:

- SNP, CHR, BP as first three columns, in this exact order.
- It has at least one of these columns: ("Z","OR","BETA","LOG_ODDS","SIGNED_SUMSTAT")
- It has all of these columns: ("SNP","CHR","BP","P","A1","A2")
- If no "N" column exists in the summary statistics, we need to input N into the call.

The UK Biobank data from Ben Neale uses GRCh37 so hit '1' when it asks. If you're using your own data and it asks you'll need to check this.

```{r, eval=FALSE }
# specify the directory of the GWAS summary statistics:
gwas_sumstats_path = "~/AD_sumstats_Jansenetal_MOD.txt"


# Format it (i.e. column headers etc)
col_headers = format_sumstats_for_magma(gwas_sumstats_path, N=369385)

```

### Map SNPs to Genes

Next to the summary statistics file, we also need to map SNPs to genes.

```{r, eval=FALSE}
genesOutPath = map.snps.to.genes(gwas_sumstats_path, genome_ref_path=genome_ref_path, N=369385)
```

### Run the main cell type association analysis per individual and generate plots per diagnosis

The to run the cell type association analysis per individual, a list of file locations with the individual cell type data files has to be provided ("ctd_loc"). This list was returned during the generate.individual.ctds function.
The analyses can be run in either linear or top10% enrichment modes. Which analysis is run is determined by the input "EnrichmentMode = "Linear" or "EnrichmentMode = "Top 10%".

The magma.run.individual.analysis function will automatically prpare quantile groups for each celltype and run the desired celltype association analysis for each individual cell type data file.
In our example, we are using an RNA-seq dataset from human tissue, so we will specify the "specificity_species" argument to "human". The "gwas_species" is also set to "human" in this example.
If we have another specificity species, we need to specify this with the "specificity_species" argument. To check species that can are compatible with MAGMA_Celltyping and the MAGMA_extension, we can use the One2One package (https://github.com/NathanSkene/One2One).

For the linear association analysis we will run


```{r, eval=FALSE }
ctd_individuals = magma.run.individual.analysis(ctd_loc = ctd_loc,specificity_species = "human", gwas_species = "human", gwas_sumstats_path = gwas_sumstats_path, genome_ref_path = genome_ref_path, EnrichmentMode = "Linear")

```

For the Top 10% mode we will run

```{r, eval=FALSE }
ctd_individuals = magma.run.individual.analysis(ctd_loc,specificity_species = "human", gwas_species = "human", gwas_sumstats_path = gwas_sumstats_path_formatted, genome_ref_path = genome_ref_path, EnrichmentMode = "Top 10%")

```

